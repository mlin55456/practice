<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品管理 - 倉儲管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
        }
        .sidebar .nav-link {
            color: #adb5bd;
        }
        .sidebar .nav-link:hover {
            color: #fff;
        }
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #495057;
        }
        .main-content {
            margin-left: 0;
        }
        @media (min-width: 768px) {
            .main-content {
                margin-left: 250px;
            }
        }
        .low-stock {
            background-color: #fff3cd;
        }
        .out-of-stock {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <!-- 側邊欄 -->
    <nav class="sidebar position-fixed d-none d-md-block">
        <div class="p-3">
            <h4 class="text-white mb-4">
                <i class="fas fa-warehouse me-2"></i>倉儲管理
            </h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="fas fa-tachometer-alt me-2"></i>儀表板
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/products">
                        <i class="fas fa-boxes me-2"></i>產品管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/transactions">
                        <i class="fas fa-exchange-alt me-2"></i>庫存異動
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/reports">
                        <i class="fas fa-chart-bar me-2"></i>報表分析
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <div class="main-content">
        <!-- 頂部導航 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <button class="btn btn-outline-secondary d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="navbar-brand mb-0 h1">產品管理</span>
                <div class="ms-auto">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openProductModal()">
                        <i class="fas fa-plus me-1"></i>新增產品
                    </button>
                </div>
            </div>
        </nav>

        <!-- 產品管理內容 -->
        <div class="container-fluid p-4">
            <!-- 搜尋和篩選 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="搜尋產品名稱或SKU...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchProducts()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                        <option value="">所有類別</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="stockFilter" onchange="filterByStock()">
                        <option value="">所有庫存狀態</option>
                        <option value="low">低庫存</option>
                        <option value="out">缺貨</option>
                    </select>
                </div>
            </div>

            <!-- 產品列表 -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>產品名稱</th>
                                    <th>類別</th>
                                    <th>庫存數量</th>
                                    <th>單價</th>
                                    <th>總價值</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> 載入中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 產品新增/編輯模態框 -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">新增產品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="productSku" class="form-label">SKU *</label>
                            <input type="text" class="form-control" id="productSku" required>
                        </div>
                        <div class="mb-3">
                            <label for="productName" class="form-label">產品名稱 *</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">類別</label>
                            <input type="text" class="form-control" id="productCategory">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productQuantity" class="form-label">庫存數量 *</label>
                                    <input type="number" class="form-control" id="productQuantity" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productPrice" class="form-label">單價 *</label>
                                    <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 庫存調整模態框 -->
    <div class="modal fade" id="stockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">庫存調整</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">產品</label>
                        <div id="stockProductInfo" class="form-control-plaintext"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">目前庫存</label>
                        <div id="currentStock" class="form-control-plaintext"></div>
                    </div>
                    <div class="mb-3">
                        <label for="stockAction" class="form-label">操作類型</label>
                        <select class="form-select" id="stockAction" onchange="updateStockForm()">
                            <option value="add">入庫</option>
                            <option value="remove">出庫</option>
                            <option value="adjust">調整</option>
                        </select>
                    </div>
                    <div class="mb-3" id="quantityGroup">
                        <label for="stockQuantity" class="form-label">數量</label>
                        <input type="number" class="form-control" id="stockQuantity" min="1" required>
                    </div>
                    <div class="mb-3" id="newQuantityGroup" style="display: none;">
                        <label for="newQuantity" class="form-label">新庫存數量</label>
                        <input type="number" class="form-control" id="newQuantity" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="stockReason" class="form-label">原因</label>
                        <input type="text" class="form-control" id="stockReason" placeholder="請輸入調整原因">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="adjustStock()">確認調整</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let allProducts = [];
        let currentEditingProduct = null;
        let currentStockProduct = null;

        // 載入產品資料
        async function loadProducts() {
            try {
                const response = await axios.get('/api/products');
                allProducts = response.data;
                displayProducts(allProducts);
                loadCategories();
            } catch (error) {
                console.error('載入產品失敗:', error);
                alert('載入產品資料失敗');
            }
        }

        // 顯示產品列表
        function displayProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">沒有找到產品</td></tr>';
                return;
            }
            
            const html = products.map(product => {
                const totalValue = (product.quantity * product.price).toFixed(2);
                let statusBadge = '';
                let rowClass = '';
                
                if (product.quantity === 0) {
                    statusBadge = '<span class="badge bg-danger">缺貨</span>';
                    rowClass = 'out-of-stock';
                } else if (product.quantity <= 10) {
                    statusBadge = '<span class="badge bg-warning">低庫存</span>';
                    rowClass = 'low-stock';
                } else {
                    statusBadge = '<span class="badge bg-success">正常</span>';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td>${product.sku}</td>
                        <td>${product.name}</td>
                        <td>${product.category || '-'}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.price.toFixed(2)}</td>
                        <td>$${totalValue}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="openStockModal(${product.id})" title="庫存調整">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        // 載入類別選項
        async function loadCategories() {
            try {
                const response = await axios.get('/api/products/categories');
                const categories = response.data;
                const select = document.getElementById('categoryFilter');
                
                // 清空現有選項（保留第一個）
                select.innerHTML = '<option value="">所有類別</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('載入類別失敗:', error);
            }
        }

        // 搜尋產品
        function searchProducts() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
                const filtered = allProducts.filter(product => 
                    product.name.toLowerCase().includes(keyword.toLowerCase()) ||
                    product.sku.toLowerCase().includes(keyword.toLowerCase())
                );
                displayProducts(filtered);
            } else {
                displayProducts(allProducts);
            }
        }

        // 按類別篩選
        function filterByCategory() {
            const category = document.getElementById('categoryFilter').value;
            if (category) {
                const filtered = allProducts.filter(product => product.category === category);
                displayProducts(filtered);
            } else {
                displayProducts(allProducts);
            }
        }

        // 按庫存狀態篩選
        function filterByStock() {
            const status = document.getElementById('stockFilter').value;
            let filtered = allProducts;
            
            if (status === 'low') {
                filtered = allProducts.filter(product => product.quantity > 0 && product.quantity <= 10);
            } else if (status === 'out') {
                filtered = allProducts.filter(product => product.quantity === 0);
            }
            
            displayProducts(filtered);
        }

        // 開啟產品模態框
        function openProductModal(product = null) {
            currentEditingProduct = product;
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            
            if (product) {
                title.textContent = '編輯產品';
                document.getElementById('productId').value = product.id;
                document.getElementById('productSku').value = product.sku;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productQuantity').value = product.quantity;
                document.getElementById('productPrice').value = product.price;
            } else {
                title.textContent = '新增產品';
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
            }
        }

        // 編輯產品
        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                openProductModal(product);
                new bootstrap.Modal(document.getElementById('productModal')).show();
            }
        }

        // 儲存產品
        async function saveProduct() {
            const form = document.getElementById('productForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const productData = {
                sku: document.getElementById('productSku').value,
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                category: document.getElementById('productCategory').value,
                quantity: parseInt(document.getElementById('productQuantity').value),
                price: parseFloat(document.getElementById('productPrice').value)
            };
            
            try {
                const productId = document.getElementById('productId').value;
                
                if (productId) {
                    // 更新產品
                    await axios.put(`/api/products/${productId}`, productData);
                } else {
                    // 新增產品
                    await axios.post('/api/products', productData);
                }
                
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                loadProducts();
                alert('產品儲存成功！');
            } catch (error) {
                console.error('儲存產品失敗:', error);
                alert('儲存產品失敗：' + (error.response?.data?.message || error.message));
            }
        }

        // 刪除產品
        async function deleteProduct(productId) {
            if (!confirm('確定要刪除這個產品嗎？')) {
                return;
            }
            
            try {
                await axios.delete(`/api/products/${productId}`);
                loadProducts();
                alert('產品刪除成功！');
            } catch (error) {
                console.error('刪除產品失敗:', error);
                alert('刪除產品失敗：' + (error.response?.data?.message || error.message));
            }
        }

        // 開啟庫存調整模態框
        function openStockModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                currentStockProduct = product;
                document.getElementById('stockProductInfo').textContent = `${product.name} (${product.sku})`;
                document.getElementById('currentStock').textContent = product.quantity;
                document.getElementById('stockAction').value = 'add';
                document.getElementById('stockQuantity').value = '';
                document.getElementById('newQuantity').value = '';
                document.getElementById('stockReason').value = '';
                updateStockForm();
                new bootstrap.Modal(document.getElementById('stockModal')).show();
            }
        }

        // 更新庫存調整表單
        function updateStockForm() {
            const action = document.getElementById('stockAction').value;
            const quantityGroup = document.getElementById('quantityGroup');
            const newQuantityGroup = document.getElementById('newQuantityGroup');
            
            if (action === 'adjust') {
                quantityGroup.style.display = 'none';
                newQuantityGroup.style.display = 'block';
            } else {
                quantityGroup.style.display = 'block';
                newQuantityGroup.style.display = 'none';
            }
        }

        // 調整庫存
        async function adjustStock() {
            const action = document.getElementById('stockAction').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const newQuantity = parseInt(document.getElementById('newQuantity').value);
            const reason = document.getElementById('stockReason').value;
            
            if (!currentStockProduct) return;
            
            try {
                let endpoint = '';
                let data = {
                    productId: currentStockProduct.id,
                    reason: reason
                };
                
                if (action === 'add') {
                    endpoint = '/api/inventory/add-stock';
                    data.quantity = quantity;
                } else if (action === 'remove') {
                    endpoint = '/api/inventory/remove-stock';
                    data.quantity = quantity;
                } else if (action === 'adjust') {
                    endpoint = '/api/inventory/adjust-stock';
                    data.newQuantity = newQuantity;
                }
                
                await axios.post(endpoint, data);
                bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
                loadProducts();
                alert('庫存調整成功！');
            } catch (error) {
                console.error('庫存調整失敗:', error);
                alert('庫存調整失敗：' + (error.response?.data?.message || error.message));
            }
        }

        // 搜尋框回車事件
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
        });
    </script>
</body>
</html>